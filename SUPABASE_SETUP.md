# Настройка Supabase для xVelvetx

## 1. Создание проекта в Supabase

1. Зайдите на [supabase.com](https://supabase.com) и войдите в свой аккаунт
2. Создайте новый проект
3. Сохраните URL проекта и anon/public ключ

## 2. Настройка базы данных

Выполните SQL-скрипт из файла `supabase-schema.sql` в SQL Editor вашего проекта Supabase:

1. Откройте SQL Editor в панели Supabase
2. Скопируйте содержимое файла `supabase-schema.sql`
3. Вставьте и выполните скрипт
4. Убедитесь, что все таблицы созданы успешно

## 3. Настройка Storage

Storage bucket для аватаров создается автоматически при выполнении SQL-скрипта.

Проверьте в разделе Storage → Buckets наличие bucket с именем `avatars`.

## 4. Настройка аутентификации

1. Перейдите в раздел Authentication → Settings
2. Включите Email auth provider
3. Настройте Email Templates (опционально)
4. Настройте Redirect URLs для вашего приложения

## 5. Настройка Environment Variables

Обновите файл `src/config/supabase.ts` с вашими учетными данными:

```typescript
const supabaseUrl = 'ВАШ_SUPABASE_URL';
const supabaseAnonKey = 'ВАШ_SUPABASE_ANON_KEY';
```

## 6. Row Level Security (RLS)

RLS политики уже настроены в SQL-скрипте:

- ✅ Пользователи могут просматривать и редактировать только свои профили
- ✅ Пользователи могут создавать и управлять только своими бронированиями
- ✅ Все могут просматривать услуги
- ✅ Пользователи могут создавать отзывы только от своего имени

## 7. Структура данных

### Таблицы

#### users
- Профили пользователей
- Автоматически создаются при регистрации через триггер
- Связаны с auth.users

#### services
- Услуги салона
- Тестовые данные загружаются автоматически

#### bookings
- Записи на услуги
- Связаны с users и services
- Статусы: pending, confirmed, cancelled, completed

#### reviews
- Отзывы на услуги
- Рейтинг от 1 до 5
- Связаны с users, services и bookings

### Storage Buckets

#### avatars
- Публичный bucket
- Структура: `{userId}/avatar.{ext}`
- Политики безопасности настроены

## 8. Realtime Subscriptions

Приложение использует Realtime для:
- Обновления бронирований пользователя
- Обновления отзывов на услуги

Убедитесь, что Realtime включен в настройках проекта.

## 9. Тестовые данные

После выполнения SQL-скрипта в базе будут созданы тестовые услуги:
- Маникюр
- Педикюр
- Массаж
- Стрижка
- Макияж
- Брови

## 10. API Endpoints

Приложение использует следующие сервисы:

### AuthService
- signUp - регистрация
- signIn - вход
- signOut - выход
- getCurrentUser - получение текущего пользователя
- updateProfile - обновление профиля

### BookingService
- getServices - получение списка услуг
- getServiceById - получение услуги по ID
- getAvailableTimeSlots - получение доступных слотов
- createBooking - создание записи
- getUserBookings - получение записей пользователя
- updateBookingStatus - обновление статуса записи
- cancelBooking - отмена записи

### ReviewService
- createReview - создание отзыва
- getServiceReviews - получение отзывов на услугу
- getUserReviews - получение отзывов пользователя
- getServiceAverageRating - получение среднего рейтинга
- updateReview - обновление отзыва
- deleteReview - удаление отзыва

### StorageService
- uploadAvatar - загрузка аватара
- deleteAvatar - удаление аватара
- getAvatarUrl - получение URL аватара

## 11. Hooks

Приложение предоставляет хуки для удобной работы с данными:

### useBookings(userId)
- Получение и отслеживание бронирований пользователя
- Автоматические обновления через Realtime

### useServices()
- Получение списка услуг
- Фильтрация по категориям

### useServiceReviews(serviceId)
- Получение отзывов на услугу
- Расчет среднего рейтинга
- Автоматические обновления через Realtime

### useUserReviews(userId)
- Получение отзывов пользователя

## 12. Безопасность

Важные моменты безопасности:

1. ✅ RLS включен на всех таблицах
2. ✅ Политики проверяют auth.uid()
3. ✅ Storage защищен политиками
4. ✅ Пароли хешируются автоматически
5. ⚠️ Не размещайте supabase ключи в публичных репозиториях

## 13. Troubleshooting

### Ошибка "JWT expired"
- Проверьте автообновление токена в настройках клиента
- autoRefreshToken: true уже установлен

### Ошибка "Row Level Security"
- Проверьте, что RLS политики настроены
- Убедитесь, что пользователь авторизован

### Ошибка загрузки аватара
- Проверьте размер файла (макс 5MB)
- Проверьте формат (jpg, png)
- Убедитесь, что bucket создан

### Realtime не работает
- Проверьте, что Realtime включен в настройках проекта
- Убедитесь, что таблицы включены для Realtime



